!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define("Pictool.browser",e):((t=t||self).Pictool=t.Pictool||{},t.Pictool.browser=e())}(this,function(){"use strict";function g(a){var i=document.createElement("img");return new Promise(function(t,e){i.onload=function(){t(i)},i.onerror=function(){e(new Error("GET_IMAGE_SRC_ERROR"))},i.src=a})}function o(t){return new Promise(function(h,o){g(t).then(function(t){var e=document.createElement("canvas"),a=t.width,i=t.height;e.width=a,e.height=i;var n=e.getContext("2d");if(n){n.clearRect(0,0,e.width,e.height),n.drawImage(t,0,0,a,i);var r=n.getImageData(0,0,a,i);h(r)}else o(new Error("canvas.getContext('2d') is null"))}).catch(function(t){o(t)})})}var b,t;(t=b=b||{}).png="image/png",t.jpg="image/webp",t.jpeg="image/jpeg";function s(t,e){void 0===e&&(e={type:b.png,encoderOptions:1});var a=e.type,i=e.encoderOptions,n=t.width,r=t.height,h=n,o=r,g=n*r,s=Math.ceil(Math.sqrt(Math.ceil(g/4e6)));1<s?(h=n/s,o=r/s):s=1;var u=document.createElement("canvas"),c=document.createElement("canvas"),f=u.getContext("2d");if(!f)return null;u.width=h,u.height=o,f.fillStyle="#FFFFFF",f.fillRect(0,0,u.width,u.height);var l=Math.ceil(g/1e6);if(1<l){var d=Math.ceil(u.width/l),v=Math.ceil(u.height/l);c.width=d,c.height=v;var m=c.getContext("2d");if(!m)return null;for(var p=d*s,D=v*s,w=d,M=v,U=0;U<l;U++)for(var _=0;_<l;_++){var y=U*d*s,I=_*v*s;m.drawImage(t,y,I,p,D,0,0,w,M),f.drawImage(c,U*d,_*v,w,M)}m.clearRect(0,0,c.width,c.height),c.width=0,c.height=0,c=null}else f.drawImage(t,0,0,h,o);var x=u.toDataURL(a,i);return f.clearRect(0,0,u.width,u.height),u.width=0,u.height=0,u=null,x}var p=(e.prototype.getWidth=function(){return null!==this._width?this._width:0},e.prototype.getHeight=function(){return null!==this._height?this._height:0},e.prototype.getData=function(){return null!==this._data?this._data:this._nullData},e.prototype.setDataUnit=function(t,e){this._data instanceof Uint8ClampedArray&&(this._data[t]=e)},e.prototype.pixelAt=function(t,e){var a=this.getWidth(),i=this.getData(),n=4*(a*e+t);return{r:i[n],g:i[1+n],b:i[2+n],a:i[3+n]}},e.prototype.destory=function(){this._data=null,this._width=null,this._height=null},e);function e(t){this._nullData=new Uint8ClampedArray(0);var e=t.width,a=t.height,i=t.data,n=e*a*4;i instanceof Uint8ClampedArray&&i.length===n?this._data=new Uint8ClampedArray(i):i instanceof Array&&i.length===n?this._data=new Uint8ClampedArray(i):this._data=new Uint8ClampedArray(n),this._width=e,this._height=a}function a(t){var e=t.getData(),a=t.getWidth(),i=t.getHeight(),n=new ImageData(a,i);return e.forEach(function(t,e){n.data[e]=t}),n}function u(t){var e=t.data,a=t.width,i=t.height;return new p({width:a,height:i,data:e})}function h(t,e){void 0===e&&(e={type:"image/png",encoderOptions:1});var a=document.createElement("canvas"),i=a.getContext("2d");a.width=t.width,a.height=t.height;var n=null;return i&&(i.clearRect(0,0,a.width,a.height),i.putImageData(t,0,0),n=a.toDataURL(e.type,e.encoderOptions)),n}function d(t){for(var e=t.getWidth(),a=t.getHeight(),i=t.getData(),n=new p({width:e,height:a,data:i}),r=0;r<e;r++)for(var h=0;h<a;h++){var o=4*(e*h+r),g=n.pixelAt(r,h),s=Math.round((g.r+g.g+g.b)/3);n.setDataUnit(o,s),n.setDataUnit(1+o,s),n.setDataUnit(2+o,s),n.setDataUnit(3+o,255)}return n}function v(t,e,a){var i=t.getWidth(),n=t.getData()[4*(i*a+e)];return 0<=n&&n<255||(n=0),n}function m(t){var e=t.h/360,a=t.s/100,i=t.l/100,n=0,r=0,h=0;if(0==a)h=r=n=function(t){var e=t*w;return e=Math.round(e),e=Math.max(0,e),e=Math.min(255,e)}(i);else{var o=[],g=.5<=i?i+a-i*a:i*(1+a),s=2*i-g;o[0]=e+1/3,o[1]=e,o[2]=e-1/3;for(var u=0;u<o.length;u++){var c=o[u];switch(c<0?c+=1:1<c&&(c-=1),!0){case c<1/6:c=s+6*(g-s)*c;break;case 1/6<=c&&c<.5:c=g;break;case.5<=c&&c<2/3:c=s+(g-s)*(4-6*c);break;default:c=s}o[u]=Math.round(c*w)}n=o[0],r=o[1],h=o[2]}return{r:n,g:r,b:h}}function D(t){return 100*t/w}var w=255,M=function(){return(M=Object.assign||function(t){for(var e,a=1,i=arguments.length;a<i;a++)for(var n in e=arguments[a])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function U(t){return-100<=t&&t<=100}function _(t,e){var a=t.r,i=t.g,n=t.b,r=D(a),h=D(i),o=D(n),g=Math.min(r,h,o),s=Math.max(r,h,o),u=s-g,c=0,f=0,l=(s+g)/2;if(s===g?f=c=0:(s===r&&o<=h?c=(h-o)/u*60+0:s===r&&h<o?c=(h-o)/u*60+360:s===h?c=(o-r)/u*60+120:s===o&&(c=(r-h)/u*60+240),0===l||s===g?f=0:0<l&&l<=127.5?f=u/(s+g):127.5<l&&(f=u/(510-(s+g)))),c=Math.round(c),f=Math.round(100*f),l=Math.round(l),e&&e.value){var d=e.value;d.h&&function(t){return 0<=t&&t<=360}(d.h)&&(c=d.h,c=Math.min(360,c),c=Math.max(0,c)),d.s&&function(t){return 0<=t&&t<=100}(d.s)&&(f=d.s,f=Math.min(100,f),f=Math.max(0,f)),d.l&&function(t){return 0<=t&&t<=100}(d.l)&&(l=d.l,l=Math.min(100,l),l=Math.max(0,l))}else if(e&&e.percent){var v=e.percent;v.h&&U(v.h)&&(c=Math.floor(c*(100+v.h)/100),c=Math.min(360,c),c=Math.max(0,c)),v.s&&U(v.s)&&(f=Math.floor(f*(100+v.s)/100),f=Math.min(100,f),f=Math.max(0,f)),v.l&&U(v.l)&&(l=Math.floor(l*(100+v.l)/100),l=Math.min(100,l),l=Math.max(0,l))}return{h:c,s:f,l:l}}function c(t,e){for(var a=t.getWidth(),i=t.getHeight(),n=t.getData(),r=new p({width:a,height:i,data:n}),h=0;h<n.length;h+=4){var o=n[h],g=n[h+1],s=n[h+2],u=n[h+3],c=_({r:o,g:g,b:s},e),f=M({},c),l=m(f);r.setDataUnit(h,l.r),r.setDataUnit(h+1,l.g),r.setDataUnit(h+2,l.b),r.setDataUnit(h+3,u)}return t.destory(),r}var i={grayscale:d,sobel:function(t){for(var e=t.getWidth(),a=t.getHeight(),i=new Uint8ClampedArray(e*a*4),n=new p({width:e,height:a,data:i}),r=[[-1,0,1],[-2,0,2],[-1,0,1]],h=[[-1,-2,-1],[0,0,0],[1,2,1]],o=d(t),g=0;g<e;g++)for(var s=0;s<a;s++){var u=r[0][0]*v(o,g-1,s-1)+r[0][1]*v(o,g,s-1)+r[0][2]*v(o,g+1,s-1)+r[1][0]*v(o,g-1,s)+r[1][1]*v(o,g,s)+r[1][2]*v(o,g+1,s)+r[2][0]*v(o,g-1,s+1)+r[2][1]*v(o,g,s+1)+r[2][2]*v(o,g+1,s+1),c=h[0][0]*v(o,g-1,s-1)+h[0][1]*v(o,g,s-1)+h[0][2]*v(o,g+1,s-1)+h[1][0]*v(o,g-1,s)+h[1][1]*v(o,g,s)+h[1][2]*v(o,g+1,s)+h[2][0]*v(o,g-1,s+1)+h[2][1]*v(o,g,s+1)+h[2][2]*v(o,g+1,s+1),f=Math.round(Math.sqrt(u*u+c*c)),l=4*(e*s+g);n.setDataUnit(l,f),n.setDataUnit(1+l,f),n.setDataUnit(2+l,f),n.setDataUnit(3+l,255)}return o.destory(),o=null,n},invert:function(t){for(var e=t.getWidth(),a=t.getHeight(),i=t.getData(),n=new p({width:e,height:a,data:i}),r=0;r<e;r++)for(var h=0;h<a;h++){var o=4*(e*h+r),g=n.pixelAt(r,h);n.setDataUnit(o,w-g.r),n.setDataUnit(1+o,w-g.g),n.setDataUnit(2+o,w-g.b),n.setDataUnit(3+o,g.a)}return n},hue:function(t,e){var a=t.getWidth(),i=t.getHeight(),n=t.getData(),r=new p({width:a,height:i,data:n}),h=void 0,o=void 0;return e.value?o={h:e.value}:e.percent&&(h={h:e.percent}),r=c(r,{percent:h,value:o})},saturation:function(t,e){var a=t.getWidth(),i=t.getHeight(),n=t.getData(),r=new p({width:a,height:i,data:n}),h=void 0,o=void 0;return e.value?o={s:e.value}:e.percent&&(h={s:e.percent}),r=c(r,{percent:h,value:o})},lightness:function(t,e){var a=t.getWidth(),i=t.getHeight(),n=t.getData(),r=new p({width:a,height:i,data:n}),h=void 0,o=void 0;return e.value?o={l:e.value}:e.percent&&(h={l:e.percent}),r=c(r,{percent:h,value:o})},alpha:function(t,e){var a=t.getWidth(),i=t.getHeight(),n=t.getData(),r=new p({width:a,height:i,data:n}),h=e.percent,o=e.value;if(h&&function(t){return-100<=t&&t<=100}(h)?(h=Math.min(100,h),h=Math.max(-100,h)):o&&function(t){return 0<=t&&t<=100}(o)&&(o=Math.min(100,o),o=Math.max(0,o)),o||0===o)for(var g=0;g<n.length;g+=4){var s=n[g],u=n[g+1],c=n[g+2],f=n[g+3];f=Math.floor(o*w/100),f=Math.min(w,f),f=Math.max(0,f),r.setDataUnit(g,s),r.setDataUnit(g+1,u),r.setDataUnit(g+2,c),r.setDataUnit(g+3,f)}else if(h||0===h)for(g=0;g<n.length;g+=4){s=n[g],u=n[g+1],c=n[g+2],f=n[g+3];f=Math.floor(f*(100+h)/100),f=Math.min(w,f),f=Math.max(0,f),r.setDataUnit(g,s),r.setDataUnit(g+1,u),r.setDataUnit(g+2,c),r.setDataUnit(g+3,f)}else for(g=0;g<n.length;g+=4){s=n[g],u=n[g+1],c=n[g+2],f=n[g+3];r.setDataUnit(g,s),r.setDataUnit(g+1,u),r.setDataUnit(g+2,c),r.setDataUnit(g+3,f)}return r},sepia:function(t){for(var e=t.getWidth(),a=t.getHeight(),i=t.getData(),n=new p({width:e,height:a,data:i}),r=0;r<e;r++)for(var h=0;h<a;h++){var o=4*(e*h+r),g=n.pixelAt(r,h),s=Math.floor(.393*g.r+.769*g.g+.189*g.b),u=Math.floor(.349*g.r+.686*g.g+.168*g.b),c=Math.floor(.272*g.r+.534*g.g+.131*g.b),f=g.a;n.setDataUnit(o,s),n.setDataUnit(1+o,u),n.setDataUnit(2+o,c),n.setDataUnit(3+o,f)}return n},posterize:function(t,e){void 0===e&&(e={});var a=t.getWidth(),i=t.getHeight(),n=t.getData(),r=new p({width:a,height:i,data:n}),h=e.value||100;h&&function(t){return 0<=t&&t<=100}(h)&&(h=Math.min(100,h),h=Math.max(0,h));for(var o=w/h,g=o,s=0;s<a;s++)for(var u=0;u<i;u++){var c=4*(a*u+s),f=r.pixelAt(s,u),l=Math.floor(Math.floor(f.r/o)*g),d=Math.floor(Math.floor(f.g/o)*g),v=Math.floor(Math.floor(f.b/o)*g),m=f.a;r.setDataUnit(c,l),r.setDataUnit(1+c,d),r.setDataUnit(2+c,v),r.setDataUnit(3+c,m)}return r},gamma:function(t,e){void 0===e&&(e={});var a=t.getWidth(),i=t.getHeight(),n=t.getData(),r=new p({width:a,height:i,data:n}),h=e.value||16;h&&function(t){return 0<=t&&t<=100}(h)&&(h=Math.min(100,h),h=Math.max(0,h));for(var o=(h+100)/200*2,g=0;g<a;g++)for(var s=0;s<i;s++){var u=4*(a*s+g),c=r.pixelAt(g,s),f=Math.floor(Math.pow(c.r,o)),l=Math.floor(Math.pow(c.g,o)),d=Math.floor(Math.pow(c.b,o)),v=c.a;r.setDataUnit(u,f),r.setDataUnit(1+u,l),r.setDataUnit(2+u,d),r.setDataUnit(3+u,v)}return r}},f=(n.prototype.process=function(t,e){if(i&&"function"!=typeof i[t])throw new Error("Pictool.digit.process."+t+" is not a function ");return this._digitImageData=i[t](this._digitImageData,e),this},n.prototype.getImageData=function(){return this._digitImageData?a(this._digitImageData):null},n.prototype.getDigitImageData=function(){return this._digitImageData},n.prototype.destory=function(){this._digitImageData&&(this._digitImageData.destory(),this._digitImageData=null)},n);function n(t){this._digitImageData=null,this._digitImageData=t}var r=(l.prototype.queueProcess=function(t){var n=this,r=[];return Array.isArray(t)?t.forEach(function(t){r.push(t)}):r.push(t),new Promise(function(a,e){n._getEffectAsync().then(function(i){r.forEach(function(t){var e=t.process,a=t.options;n._digitImg=i.process(e,a).getDigitImageData()});var t=i.getImageData(),e=h(t);a(e)}).catch(function(t){e(t)})})},l.prototype._getEffectAsync=function(){var r=this;return this._effect instanceof f?Promise.resolve(this._effect):new Promise(function(i,n){r._parseDigitAsync().then(function(t){if(!0===t){var e=r._digitImg;if(e instanceof p){var a=new f(e);r._effect=a,i(r._effect)}else n(new Error("_digitImg is null"))}else n(new Error("image src parse fail"))}).catch(function(t){n(t)})})},l.prototype._parseDigitAsync=function(){var n=this;if(this._digitImg)return Promise.resolve(!0);var t=this._options,e=1;t&&(e=t.compressRatio);var r=this._imgSrc,a=Math.max(.1,e);a=Math.min(1,e);var h={type:b.jpg,encoderOptions:a};return new Promise(function(a,i){g(r).then(function(t){var e=s(t,h);"string"==typeof e?o(e).then(function(t){var e=u(t);n._digitImg=e,a(!0)}).catch(function(t){i(t)}):i(new Error("compressImage result is null"))}).catch(function(t){i(t)})})},l);function l(t,e){this._digitImg=null,this._effect=null,this._imgSrc=t,this._options=e}return{util:{getImageBySrc:g,getImageDataBySrc:o,compressImage:s,imageData2Base64:h,digitImageData2ImageData:a,imageData2DigitImageData:u},Sandbox:r}});
